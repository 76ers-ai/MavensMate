{% extends "views/layouts/base.html" %}

{% block yield %}


  <div class="slds-notify slds-notify--toast slds-theme--info" role="alert" id="div-no-logs">
    <span class="slds-assistive-text">Success</span>
    <div class="slds-notify__content slds-grid">
      <svg aria-hidden="true" class="slds-icon slds-icon--small slds-m-right--small slds-col slds-no-flex">
        <use xlink:href="/app/static/lds/assets/icons/utility-sprite/svg/symbols.svg#info"></use>
      </svg>
      <div class="slds-col slds-align-middle">
        <h2 class="slds-text-heading--small ">This project does not have any debug logs.</h2>
        <p>To start logging, click the "Start Logging" button above. Debug log configuration can be found in your project's config/.debug file.</p>
      </div>
    </div>
  </div>

  <div class="slds-grid">
    <div class="slds-col slds-size--4-of-12">
      <table class="slds-table slds-table--bordered" id="log-list">
        <tbody>
          {% for l in logs %}
          <tr>
            <td>
              <a onclick="openLog(this)" data-location="{{mavensmate.ui.getPathBaseName(l)}}" href="#">{{mavensmate.ui.getPathBaseName(l)}}</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="slds-col--padded slds-size--8-of-12">
      <div class="slds-box slds-box--small slds-theme--shade slds-scrollable" id="log-wrapper" style="display:none;">
        <div id="log"></div>
      </div>
    </div>
  </div>
{% endblock %}

{% block buttons %}
  <button onclick="startLogging(this)" class="slds-button slds-button--brand">Start Logging</button>
  <button onclick="stopLogging(this)" class="slds-button slds-button--neutral">Stop Logging</button>
  <button onclick="flushLogs(this)" class="slds-button slds-button--neutral">Flush Logs</button>
{% endblock %}

{% block body_js %}

<script src="https://cdn.socket.io/socket.io-1.3.5.js"></script>
<script>
  'use strict';
  var editor;
  var socket = io.connect(baseLocalServerURL);

  socket.on('new-log', function (data) {
    $('#log-list > tbody').prepend('<tr><td><a data-location="'+data.locationBasename+'" href="#" onclick="openLog(this)">'+data.locationBasename+'</a></td></tr>');
    $('#div-no-logs').hide();
  });

  $(function() {
    $('#keyword').bind('keyup', function(e) {
      var code = (e.keyCode ? e.keyCode : e.which);
      if (code === 13) { //enter pressed
        filterLog();
      }
    });

    $('#keywords').change(function() {
      $('#keyword').val(this.value);
      filterLog();
    });
  });

  function startLogging(el) {
    var $button = $(el);
    $.ajax({
      type: 'POST',
      dataType: 'json',
      contentType: 'application/json; charset=utf-8',
      url: '{{ mavensmate.ui.getBaseUrl() }}/execute',
      data: JSON.stringify({
        command: 'start-logging'
      }),
      beforeSend: function() {
        $button.html('Starting...');
      },
      complete: function(data) {
        console.log(data);
        $button.html('Start Logging');
        if (data.status !== 200) {
          showMessage(JSON.parse(data.responseText).message);
        }
      }
    });
  }

  function stopLogging(el) {
    var $button = $(el);
    $.ajax({
      type: 'POST',
      dataType: 'json',
      contentType: 'application/json; charset=utf-8',
      url: '{{ mavensmate.ui.getBaseUrl() }}/execute',
      data: JSON.stringify({
        command: 'stop-logging'
      }),
      beforeSend: function() {
        $button.html('Stopping...');
      },
      complete: function(data) {
        console.log(data);
        $button.html('Stop Logging');
        if (data.status !== 200) {
          showMessage(JSON.parse(data.responseText).message);
        }
      }
    });
  }

  function flushLogs(el) {
    var $button = $(el);
    $.ajax({
      type: 'POST',
      dataType: 'json',
      contentType: 'application/json; charset=utf-8',
      url: '{{ mavensmate.ui.getBaseUrl() }}/execute',
      data: JSON.stringify({
        command: 'flush-logs'
      }),
      beforeSend: function() {
        $button.html('Flushing Logs...');
      },
      complete: function(data) {
        console.log(data);
        if (data.status !== 200) {
          showMessage(JSON.parse(data.responseText).message);
        } else if (data.status === 200) {
          $('#log-list > tbody').html('');
        }
        $('#div-no-logs').show();
        $('#log-wrapper').hide();
        $button.html('Flush Logs');
      }
    });
  }

  function openLog(el) {
    $('ul#logs li a').removeClass('selected');
    var $anchor = $(el);
    var location = $anchor.data('location');
    $('#keywords').val('').trigger('change');
    $.ajax({
      type: 'GET',
      url: '{{ mavensmate.ui.getBaseUrl() }}/app/logs/'+encodeURI(location),
      beforeSend: function() {  },
      complete: function(data) {
        console.log(data);
        // console.log(data.responseText);
        $('#location').val(location);
        $('#log').html(data.responseText);
        $anchor.addClass('selected');
        $('#log-wrapper').show();
      }
    });
  }

  function filterLog() {
    $.ajax({
      type: 'GET',
      url: '{{ mavensmate.ui.getBaseUrl() }}/app/logs/'+encodeURI(location),
      data: {
        keyword: $('#keyword').val()
      },
      beforeSend: function() {  },
      complete: function(data) {
        console.log(data);
        // console.log(data.responseText);
        $('#log').html(data.responseText);
      }
    });
  }
</script>
{% endblock %}